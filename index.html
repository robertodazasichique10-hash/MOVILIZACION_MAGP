<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>ORDEN DE COMBUSTIBLE 08D01</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --verde: #166534; --fondo: #f8fafc; --rojo: #dc2626; }
        body { font-family: 'Segoe UI', Arial; background: var(--fondo); margin: 0; padding: 10px; }
        .login-box { max-width: 380px; margin: 60px auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; border-top: 10px solid var(--verde); }
        .app-container { display: none; max-width: 900px; margin: auto; }
        .admin-panel { background: #1e293b; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; border-left: 5px solid #fbbf24; }
        .hoja { background: white; padding: 40px; border-radius: 4px; box-shadow: 0 0 20px rgba(0,0,0,0.1); border: 1px solid #ccc; position: relative; }
        .encabezado { text-align: center; border-bottom: 2px solid var(--verde); margin-bottom: 15px; padding-bottom: 10px; }
        .datos-entidad { font-size: 11px; color: #444; line-height: 1.2; }
        .seccion-titulo { background: #f1f5f9; padding: 5px 10px; font-weight: bold; font-size: 12px; margin: 15px 0 10px 0; border-left: 5px solid var(--verde); }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .double { grid-column: span 2; }
        label { font-size: 10px; font-weight: bold; color: #334155; display: block; }
        input { width: 100%; padding: 6px; border: 1px solid #94a3b8; border-radius: 4px; font-size: 12px; box-sizing: border-box; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
        table th, table td { border: 1px solid #cbd5e1; padding: 6px; text-align: center; }
        table th { background: #f1f5f9; font-size: 10px; }
        .total-row { background: #e2e8f0; font-weight: bold; }
        .total-row input { font-weight: bold; background: transparent; border: none; text-align: center; color: #000; }

        .firmas-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 50px; margin-top: 30px; text-align: center; }
        canvas { border: 1px solid #000; background: #fff; width: 100%; height: 80px; }
        .pie-firma { border-top: 1px solid #000; font-size: 9px; font-weight: bold; margin-top: 5px; }
        
        .btn { width: 100%; padding: 15px; background: var(--verde); color: white; border: none; font-weight: bold; border-radius: 6px; cursor: pointer; margin-top: 15px; }
        .top-bar { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center; }
        .btn-top { background: #64748b; color: white; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; margin-left: 5px; }
        
        #qr-code { position: absolute; top: 40px; right: 40px; }
        .num-manual { position: absolute; top: 130px; right: 40px; text-align: right; }
        #numOrden { font-size: 22px; font-weight: bold; color: var(--rojo); border: 2px solid var(--rojo); width: 120px; text-align: center; background: #fef2f2; }
    </style>
</head>
<body>

    <div id="login" class="login-box">
        <h2 style="color:var(--verde); margin-bottom:5px;">ORDEN DE COMBUSTIBLE</h2>
        <p style="font-size:11px; font-weight:bold; margin-bottom:20px;">DIRECCI√ìN DISTRITAL 08D01 ESMERALDAS MAGP</p>
        <input type="text" id="u" placeholder="C√©dula de Identidad" style="margin-bottom:10px">
        <input type="password" id="p" placeholder="Contrase√±a" style="margin-bottom:20px">
        <button class="btn" onclick="acceder()">ENTRAR AL SISTEMA</button>
    </div>

    <div id="app" class="app-container">
        <div class="top-bar">
            <div id="status" style="font-weight:bold; color:var(--verde);"></div>
            <div>
                <button class="btn-top" onclick="cambiarClaveSegura()" style="background:#0ea5e9;">üîë Cambiar Clave</button>
                <button class="btn-top" onclick="location.reload()" style="background:#ef4444;">‚ùå Cerrar Sesi√≥n</button>
            </div>
        </div>

        <div id="panelAdmin" class="admin-panel">
            <h4 style="margin:0 0 10px 0;">üõ†Ô∏è PANEL DE ADMINISTRACI√ìN MAGP</h4>
            <input type="text" id="newCedula" placeholder="C√©dula" style="width:150px;">
            <select id="newRol" style="width:180px;">
                <option value="Conductor">Conductor</option>
                <option value="Responsable de Transporte">Responsable de Transporte</option>
            </select>
            <button onclick="crearUsuario()" style="padding:6px; cursor:pointer; background: var(--verde); color:white; border:none; border-radius:4px;">Registrar</button>
        </div>

        <div class="hoja" id="ordenPDF">
            <div id="qr-code"></div>
            <div class="num-manual">
                <label style="color:var(--rojo); font-weight:bold; font-size:9px;">ORDEN DE DESPACHO N¬∞:</label>
                <input type="text" id="numOrden" placeholder="0000">
            </div>

            <div class="encabezado">
                <h2 style="margin:0; color:var(--verde); font-size:18px;">ORDEN DE DESPACHO DE COMBUSTIBLE</h2>
                <h3 style="margin:5px 0; font-size:14px;">DIRECCI√ìN DISTRITAL 08D01 ESMERALDAS MAGP</h3>
                <div class="datos-entidad">
                    PEDRO VICENTE MALDONADO ENTRE MANUELA CA√ëIZAREZ Y FRANCISCO MEJIA<br>
                    TEL√âFONO: 063700590 | UNIDAD DE TRANSPORTE
                </div>
            </div>

            <div class="grid">
                <div class="double"><label>CLIENTE:</label><input type="text" value="DIRECCI√ìN DISTRITAL 08D01 ESMERALDAS MAGP" readonly></div>
                <div><label>FECHA:</label><input type="date" id="f_actual"></div>
            </div>

            <div class="seccion-titulo">DATOS DEL VEH√çCULO Y CONDUCTOR</div>
            <div class="grid">
                <div><label>TIPO DE VEH√çCULO:</label><input type="text"></div>
                <div><label>PLACA DEL VEH√çCULO:</label><input type="text" id="placa"></div>
                <div><label>KILOMETRAJE SALIDA:</label><input type="number"></div>
                <div class="double"><label>NOMBRE DEL CONDUCTOR:</label><input type="text"></div>
                <div><label>C√âDULA CONDUCTOR:</label><input type="text" id="cedulaCond"></div>
            </div>

            <div class="seccion-titulo">DESCRIPCI√ìN DEL SUMINISTRO</div>
            <table>
                <thead>
                    <tr>
                        <th>CONCEPTO</th>
                        <th>GALONES / CANTIDAD</th>
                        <th>VALOR TOTAL (INC. IVA) $</th>
                    </tr>
                </thead>
                <tbody id="tabla-body">
                    <tr><td>SUPER</td><td><input type="number" class="gal" step="0.01" oninput="sumar()"></td><td><input type="number" class="val" step="0.01" oninput="sumar()"></td></tr>
                    <tr><td>EXTRA</td><td><input type="number" class="gal" step="0.01" oninput="sumar()"></td><td><input type="number" class="val" step="0.01" oninput="sumar()"></td></tr>
                    <tr><td>DIESEL</td><td><input type="number" class="gal" step="0.01" oninput="sumar()"></td><td><input type="number" class="val" step="0.01" oninput="sumar()"></td></tr>
                    <tr><td>LUBRICANTES</td><td><input type="number" class="gal" step="0.01" oninput="sumar()"></td><td><input type="number" class="val" step="0.01" oninput="sumar()"></td></tr>
                    <tr><td>LAVADO</td><td>-</td><td><input type="number" class="val" step="0.01" oninput="sumar()"></td></tr>
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td>TOTALES</td>
                        <td><input type="text" id="totalGal" value="0.00" readonly></td>
                        <td><input type="text" id="totalVal" value="0.00" readonly></td>
                    </tr>
                </tfoot>
            </table>

            <div style="margin-top:15px;">
                <label>MOTIVO DE LA SALIDA:</label>
                <input type="text">
            </div>

            <div class="firmas-grid">
                <div>
                    <canvas id="sig1"></canvas>
                    <div class="pie-firma">FIRMA DEL CONDUCTOR</div>
                    <div id="h1" style="font-size:7px"></div>
                </div>
                <div>
                    <canvas id="sig2"></canvas>
                    <div class="pie-firma">RESPONSABLE DE TRANSPORTE</div>
                    <div id="h2" style="font-size:7px"></div>
                </div>
            </div>
        </div>

        <button class="btn" onclick="descargarPDF()">GENERAR ORDEN DE DESPACHO</button>
    </div>

    <script>
        let currentUser = "";
        let db = JSON.parse(localStorage.getItem('db_comb_v2')) || { "0801550096": {clave:"Roberto_1971", rol:"Admin"} };

        function acceder() {
            const u = document.getElementById('u').value, p = document.getElementById('p').value;
            if(db[u] && db[u].clave === p) {
                currentUser = u;
                document.getElementById('login').style.display='none';
                document.getElementById('app').style.display='block';
                document.getElementById('cedulaCond').value = u;
                document.getElementById('status').innerText = "Personal MAGP: " + u;
                document.getElementById('f_actual').valueAsDate = new Date();
                if(u === "0801550096") document.getElementById('panelAdmin').style.display='block';
                prepararFirmas();
                generarQR("ESPERANDO DATOS...");
            } else { alert("Acceso denegado."); }
        }

        function sumar() {
            let tGal = 0, tVal = 0;
            document.querySelectorAll('.gal').forEach(i => tGal += (parseFloat(i.value) || 0));
            document.querySelectorAll('.val').forEach(i => tVal += (parseFloat(i.value) || 0));
            document.getElementById('totalGal').value = tGal.toFixed(2);
            document.getElementById('totalVal').value = tVal.toFixed(2);
        }

        function cambiarClaveSegura() {
            const ant = prompt("Clave Anterior:");
            if (ant === db[currentUser].clave) {
                const n = prompt("Nueva Clave:");
                if (n && n.length > 3) {
                    db[currentUser].clave = n;
                    localStorage.setItem('db_comb_v2', JSON.stringify(db));
                    alert("Clave actualizada.");
                }
            } else { alert("Error de validaci√≥n."); }
        }

        function crearUsuario() {
            const c = document.getElementById('newCedula').value, r = document.getElementById('newRol').value;
            if(c.length < 10) return alert("C√©dula inv√°lida");
            db[c] = {clave: c, rol: r};
            localStorage.setItem('db_comb_v2', JSON.stringify(db));
            alert("Usuario registrado.");
        }

        function generarQR(txt) {
            const cont = document.getElementById("qr-code");
            cont.innerHTML = "";
            new QRCode(cont, { text: txt, width: 80, height: 80 });
        }

        function prepararFirmas() {
            ['sig1','sig2'].forEach((id, idx) => {
                const cv = document.getElementById(id), ctx = cv.getContext("2d");
                let d = false;
                const p = (e) => { 
                    const r = cv.getBoundingClientRect(); 
                    return { x: (e.clientX || e.touches[0].clientX) - r.left, y: (e.clientY || e.touches[0].clientY) - r.top };
                };
                const start = (e) => { d=true; ctx.beginPath(); ctx.moveTo(p(e).x, p(e).y); document.getElementById('h'+(idx+1)).innerText = "Fecha/Hora: " + new Date().toLocaleString(); };
                cv.onmousedown = start; cv.onmousemove = (e) => { if(d) { ctx.lineTo(p(e).x, p(e).y); ctx.stroke(); } };
                window.onmouseup = () => d=false;
                cv.ontouchstart = (e) => { start(e); e.preventDefault(); };
                cv.ontouchmove = (e) => { if(d) { ctx.lineTo(p(e).x, p(e).y); ctx.stroke(); e.preventDefault(); } };
            });
        }

        function descargarPDF() {
            const num = document.getElementById('numOrden').value.trim();
            if(!num) return alert("¬°Atenci√≥n! Ingrese el n√∫mero de orden manual antes de descargar.");
            
            const placa = document.getElementById('placa').value || "S/N";
            const val = document.getElementById('totalVal').value;
            generarQR("MAGP-COMB | ORDEN: " + num + " | PLACA: " + placa + " | TOTAL: $" + val);

            const btn = document.querySelector('.btn'), bar = document.querySelector('.top-bar');
            btn.style.display='none'; bar.style.display='none';
            
            html2pdf().set({ margin: 0.3, filename: 'Orden_Comb_'+num+'.pdf', html2canvas: { scale: 2 } })
            .from(document.getElementById('ordenPDF')).save().then(()=>{
                btn.style.display='block'; bar.style.display='flex';
            });
        }
    </script>
</body>
</html>